<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crypto Sniper ‚Äì Pivot High & Filtri Persistenti</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; margin: 0; padding: 10px; }
    h1 { text-align: center; margin-bottom: 20px; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; justify-content: center; }
    .controls label { font-size: 14px; display: flex; align-items: center; gap: 4px; }
    select, input[type=number] { padding: 6px; border-radius: 4px; border: 1px solid #555; background: #333; color: #eee; }
    select[multiple] { height: auto; min-height: 80px; }
    input[type=checkbox] { transform: scale(1.1); }
    button { padding: 6px 12px; border: none; border-radius: 4px; background: #4caf50; color: #fff; cursor: pointer; }
    button:hover { background: #45a049; }
    #status { text-align: center; padding: 8px; margin-bottom: 10px; background: #333; border-radius: 4px; }
    #status.active { background: linear-gradient(90deg,#00ff88,#00cc66); color: #000; }
    #results .coin {
      background: linear-gradient(135deg,#222,#333);
      padding: 12px; margin-bottom: 10px; border-radius: 6px;
      border-left: 4px solid #00ff88;
      transition: transform .2s, background .3s;
    }
    .coin.bybit  { border-color: #f7931a; }
    .coin.binance{ border-color: #f3ba2f; }
    .coin:hover  { transform: translateX(5px); }
    .coin.alerted{ background: rgba(0,255,0,0.2) !important; }
    .exchange-badge { display:inline-block; padding:4px 8px; border-radius:12px; font-size:11px; margin-bottom:8px; }
    .exchange-badge.binance{ background:#f3ba2f; color:#000; }
    .exchange-badge.bybit  { background:#f7931a; color:#000; }
    .gain { color: #00ff88; font-weight: bold; }
    .daily-change { color:#1e90ff; }
    .tradingview-link, .exchange-link {
      display:inline-block; padding:4px 8px; border-radius:4px; font-size:12px;
      text-decoration:none; margin-right:6px;
    }
    .tradingview-link { background:#1e88e5; color:#fff; }
    .tradingview-link.checked { background:#ff5722 !important; }
    .exchange-link.binance{ background:#f3ba2f; color:#000; }
    .exchange-link.bybit  { background:#f7931a; color:#000; }
    .alert-label, .custom-label { display:flex; align-items:center; gap:4px; margin-top:8px; font-size:13px; }
    .alert-indicator { margin-left:6px; }
    .custom-threshold { width:70px; padding:4px; background:#333; border:1px solid #555; color:#eee; border-radius:3px; }
  </style>
</head>
<body>
  <h1>üìà Crypto Sniper ‚Äì Pivot High &amp; Filtri Persistenti</h1>

  <div id="status">‚è∏ In attesa di avvio‚Ä¶</div>

  <div class="controls">
    <label>Timeframe:
      <select id="timeframe">
        <option value="1m">1m</option>
        <option value="5m" selected>5m</option>
        <option value="15m">15m</option>
        <option value="30m">30m</option>
        <option value="1h">1h</option>
        <option value="4h">4h</option>
        <option value="1d">1d</option>
      </select>
    </label>
    <label><input type="checkbox" id="enableGain" checked/> Filtro Gain</label>
    <label>Soglia Gain (%):
      <input type="number" id="threshold" value="3.0" step="0.1" min="0"/>
    </label>
    <label>Pivot Left (N):
      <input type="number" id="pivotLeft" value="1" step="1" min="1"/>
    </label>
    <label>Pivot Right (M):
      <input type="number" id="pivotRight" value="3" step="1" min="1"/>
    </label>
    <label><input type="checkbox" id="enableDist" checked/> Filtro Distanza</label>
    <label>Distanza max (%):
      <input type="number" id="distThreshold" value="10.0" step="0.1" min="0" max="100"/>
    </label>
    <label>Soglia Allarme (%):
      <input type="number" id="alertThreshold" value="2.0" step="0.1" min="0"/>
    </label>
    <button id="startBtn">‚ñ∂ Avvia Analisi</button>
  </div>

  <div class="controls">
    <label>Ordina per (multi):
      <select id="sortCriteria" multiple size="5">
        <option value="distance" selected>Distanza dal PivotHigh</option>
        <option value="pivotGain">Pivot Gain%</option>
        <option value="dailyChange">% 24h</option>
        <option value="volume">Volume</option>
        <option value="exchange">Exchange</option>
      </select>
    </label>
  </div>

  <div id="results"></div>

  <script>
    const TELEGRAM_TOKEN   = "7919987275:AAGeKy3A-ZtmYm4RZRDEb7MVz6JrOxx95Lc";
    const TELEGRAM_CHAT_ID = "525164223";

    let allSymbols   = [];
    let cycleCount   = 0;
    let wakeLock     = null;
    const resultsMap = new Map();
    const alerted    = new Set();
    const checked    = new Set();

    function updateStatus(msg, active = false) {
      const s = document.getElementById('status');
      s.textContent = msg;
      s.className = active ? 'active' : '';
    }
    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try { wakeLock = await navigator.wakeLock.request('screen'); }
        catch (e) { console.error(e); }
      }
    }
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && wakeLock === null) requestWakeLock();
    });

    document.getElementById('startBtn').addEventListener('click', () => {
      cycleCount = 0;
      allSymbols = [];
      resultsMap.clear();
      document.getElementById('results').innerHTML = '';
      cycleProcessing();
      requestWakeLock();
    });
    document.getElementById('sortCriteria').addEventListener('change', sortResults);

    async function getSymbols() {
      const syms = [];
      try {
        const r = await fetch('https://api.binance.com/api/v3/ticker/price');
        const jb = await r.json();
        jb.forEach(o => {
          if (o.symbol.endsWith('USDT')||o.symbol.endsWith('USDC'))
            syms.push({exchange:'binance',symbol:o.symbol});
        });
      } catch(e){ console.error(e); }
      try {
        const r = await fetch('https://api.bybit.com/v5/market/tickers?category=spot');
        const jb = await r.json();
        (jb.result.list||[]).forEach(o => {
          if (o.symbol.endsWith('USDT')||o.symbol.endsWith('USDC'))
            syms.push({exchange:'bybit',symbol:o.symbol});
        });
      } catch(e){ console.error(e); }
      return syms;
    }

    async function getCurrentPrice(ex,sym) {
      try {
        if (ex==='binance') {
          const j = await (await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${sym}`)).json();
          return parseFloat(j.price);
        } else {
          const j = await (await fetch(`https://api.bybit.com/v5/market/ticker?category=spot&symbol=${sym}`)).json();
          const itm = j.result.list[0]||{};
          return parseFloat(itm.lastPrice||itm.price24h||0);
        }
      } catch {
        return 0;
      }
    }

    function isPivotHigh(data,i,L,R) {
      if (i < L || i + R >= data.length) return false;
      const h0 = +data[i][2];
      for (let j=1;j<=L;j++) if (+data[i-j][2]>=h0) return false;
      for (let k=1;k<=R;k++) if (+data[i+k][2]>=h0) return false;
      return true;
    }

    function getTVLink(sym,iv,ex) {
      const m={'1m':'1','5m':'5','15m':'15','30m':'30','1h':'60','4h':'240','1d':'1D'};
      return `https://www.tradingview.com/chart/?symbol=${ex}:${sym}&interval=${m[iv]||'5'}&theme=dark`;
    }
    function getExLink(sym,ex) {
      if (ex==='binance') return `https://www.binance.com/en/trade/${sym.replace(/USDT|USDC/,'')}_USDC`;
      if (ex==='bybit')   return `https://www.bybit.com/en/trade/spot/${sym}`;
      return '#';
    }
    function launchLink(u){ window.open(u,'_blank'); }
    async function sendTelegram(text){
      try {
        await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({chat_id:TELEGRAM_CHAT_ID,text,parse_mode:'HTML'})
        });
      } catch(e){ console.error(e); }
    }

    function sortResults() {
      const chosen = Array.from(
        document.getElementById('sortCriteria').selectedOptions
      ).map(o=>o.value);

      const container = document.getElementById('results');
      const items = Array.from(container.children);

      items.sort((A,B)=>{
        for (let crit of chosen) {
          let va, vb;
          switch(crit) {
            case 'distance':
              va = +A.querySelector('.distance-value').textContent;
              vb = +B.querySelector('.distance-value').textContent;
              if (va!==vb) return va - vb;
              break;
            case 'pivotGain':
              va = +A.querySelector('.gain').textContent;
              vb = +B.querySelector('.gain').textContent;
              if (va!==vb) return vb - va;
              break;
            case 'dailyChange':
              va = +A.querySelector('.daily-change').textContent;
              vb = +B.querySelector('.daily-change').textContent;
              if (va!==vb) return vb - va;
              break;
            case 'volume':
              va = +A.querySelector('.volume-value').textContent;
              vb = +B.querySelector('.volume-value').textContent;
              if (va!==vb) return vb - va;
              break;
            case 'exchange':
              const ea = A.querySelector('.exchange-badge').textContent==='BINANCE';
              const eb = B.querySelector('.exchange-badge').textContent==='BINANCE';
              if (ea!==eb) return ea? -1:1;
              break;
          }
        }
        return 0;
      });

      items.forEach(el=>container.appendChild(el));
    }

    async function removeStale() {
      for (let [k,el] of resultsMap) {
        const [ex,sym] = k.split('|');
        const p = await getCurrentPrice(ex,sym);
        if (p >= +el.dataset.pivotVal) {
          el.remove();
          resultsMap.delete(k);
          alerted.delete(k);
          checked.delete(k);
        }
      }
    }

    function checkAlert(c){
      const k = `${c.exchange}|${c.symbol}`,
            el = resultsMap.get(k),
            cb = el.querySelector('.alert-checkbox'),
            ct = +el.querySelector('.custom-threshold').value||0,
            gl = +document.getElementById('alertThreshold').value||0,
            useD = document.getElementById('enableDist').checked,
            dist = c.distance, pv=c.pivotValue, cl=c.close,
            trig=cb.checked&& (ct>0?((pv-cl)<=ct):(useD?dist<=gl:false));
      if(trig&&!alerted.has(k)){
        sendTelegram(
          `üö® <b>${c.symbol}</b> ‚Äì ${c.exchange}\n`+
          `PivotHigh: ${c.pivotValue}\n`+
          `Close: ${c.close}\n`+
          `Œî%: ${c.distance}%\n`+
          `<a href="${c.tradingViewUrl}">TV</a>`
        );
        alerted.add(k);
        el.querySelector('.alert-indicator').textContent='‚úÖ';
        el.classList.add('alerted');
      }
    }

    function upsertResult(c){
      const k=`${c.exchange}|${c.symbol}`, cont=document.getElementById('results'),
            old=resultsMap.get(k);
      let el=old;
      if(el){
        el.querySelector('.gain').textContent           = `+${c.gain}%`;
        el.querySelector('.daily-change').textContent   = `${c.dailyChange}%`;
        el.querySelector('.distance-value').textContent = `${c.distance}%`;
        el.querySelector('.volume-value').textContent   = c.volume;
        el.dataset.pivotVal = c.pivotValue;
      } else {
        el=document.createElement('div');
        el.className=`coin ${c.exchange}`;
        el.dataset.pivotVal=c.pivotValue;
        el.innerHTML=`
          <div class="exchange-badge ${c.exchange}">${c.exchange.toUpperCase()}</div>
          <div><strong>üí∞ ${c.symbol}</strong></div>
          <div>üìä Gain: <span class="gain">+${c.gain}%</span> | 24h: <span class="daily-change">${c.dailyChange}%</span></div>
          <div>üíß Volume: <span class="volume-value">${c.volume}</span></div>
          <div>‚ö° Distance: <span class="distance-value">${c.distance}%</span></div>
          <div>‚öì PivotHigh: ${c.pivotValue} @ <span class="pivottime">${c.pivotTime}</span></div>
          <div>üîó 
            <a class="tradingview-link" href="#">TV</a>
            <a class="exchange-link ${c.exchange}" href="#">Exch</a>
          </div>
          <label class="alert-label">
            <input type="checkbox" class="alert-checkbox"/>Allarme
            <span class="alert-indicator">‚ùå</span>
          </label>
          <label class="custom-label">
            <input type="number" class="custom-threshold" step="0.1" placeholder="Abs"/>Absolute
          </label>`;
        const tv=el.querySelector('.tradingview-link'),
              exl=el.querySelector('.exchange-link'),
              cb=el.querySelector('.alert-checkbox'),
              ct=el.querySelector('.custom-threshold');
        tv.addEventListener('click',e=>{
          e.preventDefault();
          launchLink(c.tradingViewUrl);
          tv.classList.add('checked');
          checked.add(k);
        });
        if(checked.has(k))tv.classList.add('checked');
        exl.addEventListener('click',e=>{
          e.preventDefault();
          launchLink(c.exchangeUrl);
        });
        cb.addEventListener('change',()=>{
          if(!cb.checked){
            alerted.delete(k);
            el.querySelector('.alert-indicator').textContent='‚ùå';
            el.classList.remove('alerted');
          }
        });
        ct.addEventListener('input',()=>cb.checked=true);
        resultsMap.set(k,el);
        cont.appendChild(el);
      }
      sortResults();
      checkAlert(c);
    }

    async function getBinanceData(sym,iv,L,R){
      try {
        const limit=L+R+2;
        const kl=await (await fetch(`https://api.binance.com/api/v3/klines?symbol=${sym}&interval=${iv}&limit=${limit}`)).json();
        if(!Array.isArray(kl))return null;
        let best=null;
        for(let i=L;i<kl.length-R;i++){
          if(!isPivotHigh(kl,i,L,R))continue;
          const o=+kl[i][1], c=+kl[i][4], g=((c-o)/o*100).toFixed(2);
          if(!best||g*1>best.gain*1)best={gain:g,pivotValue:+kl[i][2],pivotTs:kl[i][0],volume:+kl[i][5]};
        }
        if(!best)return null;
        const t2=await(await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${sym}`)).json();
        const dc=parseFloat(t2.priceChangePercent).toFixed(2),
              volume=parseFloat(t2.volume).toFixed(0),
              current=await getCurrentPrice('binance',sym),
              dist=((best.pivotValue-current)/best.pivotValue*100).toFixed(2);
        return {
          exchange:'binance',symbol:sym,gain:best.gain,dailyChange:dc,
          volume,pivotValue:best.pivotValue,pivotTime:new Date(best.pivotTs).toLocaleTimeString(),
          close:current.toFixed(6),distance:dist,
          tradingViewUrl:getTVLink(sym,iv,'BINANCE'),
          exchangeUrl:getExLink(sym,'binance')
        };
      } catch {return null;}
    }

    async function getBybitData(sym,iv,L,R){
      try {
        const klj=await(await fetch(
          `https://api.bybit.com/v5/market/kline?category=spot&symbol=${sym}&interval=${iv}&limit=${L+R+2}`
        )).json();
        const kl=klj.result.list.reverse();
        let best=null;
        for(let i=L;i<kl.length-R;i++){
          if(!isPivotHigh(kl,i,L,R))continue;
          const o=+kl[i].open,c=+kl[i].close,g=((c-o)/o*100).toFixed(2);
          if(!best||g*1>best.gain*1)best={gain:g,pivotValue:+kl[i].high,pivotTs:kl[i].start,volume:+kl[i].5};
        }
        if(!best)return null;
        const j2=await(await fetch(
          `https://api.bybit.com/v5/market/ticker/24hr?category=spot&symbol=${sym}`
        )).json();
        const t2=j2.result.list[0],
              dc=(parseFloat(t2.price_24h_pcnt)*100).toFixed(2),
              volume=parseFloat(t2.turnover_24h).toFixed(0),
              current=await getCurrentPrice('bybit',sym),
              dist=((best.pivotValue-current)/best.pivotValue*100).toFixed(2);
        return {
          exchange:'bybit',symbol:sym,gain:best.gain,dailyChange:dc,volume,
          pivotValue:best.pivotValue,pivotTime:new Date(best.pivotTs).toLocaleTimeString(),
          close:current.toFixed(6),distance:dist,
          tradingViewUrl:getTVLink(sym,iv,'BYBIT'),
          exchangeUrl:getExLink(sym,'bybit')
        };
      } catch {return null;}
    }

    async function cycleProcessing(){
      try {
        if(allSymbols.length===0){
          updateStatus('üì• Caricamento simboli‚Ä¶',false);
          allSymbols=await getSymbols();
        }
        cycleCount++;
        updateStatus(`üîÑ Inizio Ciclo ${cycleCount} ‚Äì 0/${allSymbols.length} (0%)`,true);
        const tf=document.getElementById('timeframe').value,
              L=+document.getElementById('pivotLeft').value,
              R=+document.getElementById('pivotRight').value,
              ge=document.getElementById('enableGain').checked,
              gt=+document.getElementById('threshold').value,
              de=document.getElementById('enableDist').checked,
              dt=+document.getElementById('distThreshold').value;
        let done=0, start=Date.now();
        for(let {exchange,symbol} of allSymbols){
          let cnd=null;
          if(exchange==='binance') cnd=await getBinanceData(symbol,tf,L,R);
          else                    cnd=await getBybitData(symbol,tf,L,R);
          if(cnd){
            if((!ge||cnd.gain>=gt) && (!de||cnd.distance<=dt)){
              upsertResult(cnd);
            }
          }
          done++;
          const pct=((done/allSymbols.length)*100).toFixed(1),
                secs=Math.floor((Date.now()-start)/1000);
          updateStatus(`üîÑ Ciclo ${cycleCount} ‚Äì ${done}/${allSymbols.length} (${pct}%) ‚Äì ${secs}s`,true);
          await new Promise(r=>setTimeout(r,50));
        }
        await removeStale();
        updateStatus(`‚úÖ Ciclo ${cycleCount} terminato. Riparte tra 3s`,false);
      } catch(e){
        console.error(e);
        updateStatus(`‚ùó Errore, riprovo tra 5s`,false);
      } finally {
        setTimeout(cycleProcessing,3000);
      }
    }
  </script>
</body>
</html>
```
