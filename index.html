<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crypto Sniper ‚Äì Pivot High & Filtri Persistenti</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; margin: 0; padding: 10px; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; justify-content: center; }
    .controls label { font-size: 14px; display: flex; align-items: center; gap: 4px; }
    select, input[type=number] { padding: 6px; border-radius: 4px; border: 1px solid #555; background: #333; color: #eee; }
    select[multiple] { height: auto; min-height: 80px; }
    input[type=checkbox] { transform: scale(1.1); }
    button { padding: 6px 12px; border: none; border-radius: 4px; background: #4caf50; color: #fff; cursor: pointer; }
    button:hover { background: #45a049; }
    #status { text-align: center; padding: 8px; margin-bottom: 10px; background: #333; border-radius: 4px; }
    #status.active { background: linear-gradient(90deg,#00ff88,#00cc66); color: #000; }
    #results .coin {
      background: linear-gradient(135deg,#222,#333);
      padding: 12px; margin-bottom: 10px; border-radius: 6px;
      border-left: 4px solid #00ff88; transition: transform .2s, background .3s;
    }
    .coin.bybit { border-color: #f7931a; }
    .coin.binance { border-color: #f3ba2f; }
    .coin:hover { transform: translateX(5px); }
    .coin.alerted { background: rgba(0,255,0,0.2) !important; }
    .exchange-badge { display:inline-block; padding:4px 8px; border-radius:12px; font-size:11px; margin-bottom:8px; }
    .exchange-badge.binance { background:#f3ba2f; color:#000; }
    .exchange-badge.bybit { background:#f7931a; color:#000; }
    .gain { color: #00ff88; font-weight: bold; }
    .tradingview-link, .exchange-link {
      display:inline-block; padding:4px 8px; border-radius:4px; font-size:12px; text-decoration:none; margin-right:6px;
    }
    .tradingview-link { background:#1e88e5; color:#fff; }
    .tradingview-link.checked { background:#ff5722 !important; }
    .exchange-link.binance { background:#f3ba2f; color:#000; }
    .exchange-link.bybit { background:#f7931a; color:#000; }
    .alert-label { display:flex; align-items:center; gap:4px; margin-top:8px; font-size:13px; }
    .alert-indicator { margin-left:6px; }
    .custom-label { display:flex; align-items:center; gap:4px; margin-top:6px; font-size:13px; }
    .custom-price { width:100px; padding:4px; background:#333; border:1px solid #555; color:#eee; border-radius:3px; }
  </style>
</head>
<body>
  <h1>üìà Crypto Sniper ‚Äì Pivot High & Filtri Persistenti</h1>
  <div id="status">‚è∏ In attesa di avvio‚Ä¶</div>
  <div class="controls">
    <label>Timeframe:
      <select id="timeframe">
        <option value="1m">1m</option>
        <option value="5m" selected>5m</option>
        <option value="15m">15m</option>
        <option value="30m">30m</option>
        <option value="1h">1h</option>
        <option value="4h">4h</option>
        <option value="1d">1d</option>
      </select>
    </label>
    <label><input type="checkbox" id="enableGain" /> Abilita Filtro Gain</label>
    <label>Soglia Gain (%):
      <input type="number" id="threshold" value="3.0" step="0.1" min="0"/>
    </label>
    <label>Pivot Left (N):
      <input type="number" id="pivotLeft" value="1" step="1" min="1"/>
    </label>
    <label>Pivot Right (M):
      <input type="number" id="pivotRight" value="3" step="1" min="1"/>
    </label>
    <label><input type="checkbox" id="enableDist" checked/> Abilita Distanza Pivot</label>
    <label>Distanza max (%):
      <input type="number" id="distThreshold" value="10.0" step="0.1" min="0" max="100"/>
    </label>
    <label>Soglia Allarme (%):
      <input type="number" id="alertThreshold" value="2.0" step="0.1" min="0"/>
    </label>
    <label>Ordina per (multi):
      <select id="sortCriteria" multiple size="4">
        <option value="pivotGain">Pivot Gain%</option>
        <option value="dailyChange">% 24h</option>
        <option value="volume">Volume</option>
        <option value="exchange">Exchange</option>
      </select>
    </label>
    <button id="startBtn">‚ñ∂ Avvia Analisi</button>
  </div>
  <div id="results"></div>

  <script>
    const TELEGRAM_TOKEN = "7919987275:AAGeKy3A-ZtmYm4RZRDEb7MVz6JrOxx95Lc";
    const TELEGRAM_CHAT_ID = "525164223";

    let allSymbols = [],
        currentIndex = 0,
        batchSize = 150,
        cycleStart = null,
        wakeLock = null,
        resultsMap = new Map(),
        alerted = new Set(),
        checked = new Set(),
        cycleCount = 0;

    function updateStatus(msg, active = false) {
      const s = document.getElementById('status');
      s.textContent = msg;
      s.className = active ? 'active' : '';
    }

    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try { wakeLock = await navigator.wakeLock.request('screen'); }
        catch (e) { console.error(e); }
      }
    }
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && wakeLock === null) requestWakeLock();
    });

    function sortResults() {
      const chosen = Array.from(document.getElementById('sortCriteria')
        .selectedOptions).map(o => o.value);
      const container = document.getElementById('results'),
            items = Array.from(container.children);

      items.sort((a, b) => {
        // primo criterio: distanza percentuale
        const da = +a.querySelector('.distance-value').textContent;
        const db = +b.querySelector('.distance-value').textContent;
        if (da !== db) return da - db;

        // poi i criteri scelti
        for (let crit of ['pivotGain','dailyChange','volume','exchange']) {
          if (!chosen.includes(crit)) continue;
          let cmp = 0;
          if (crit === 'pivotGain') {
            cmp = +b.querySelector('.gain').textContent
                - +a.querySelector('.gain').textContent;
          }
          if (crit === 'dailyChange') {
            cmp = +b.querySelector('.daily-change').textContent
                - +a.querySelector('.daily-change').textContent;
          }
          if (crit === 'volume') {
            cmp = +b.querySelector('.volume-value').textContent
                - +a.querySelector('.volume-value').textContent;
          }
          if (crit === 'exchange') {
            const ea = a.querySelector('.exchange-badge').textContent === 'BINANCE';
            const eb = b.querySelector('.exchange-badge').textContent === 'BINANCE';
            if (ea && !eb) cmp = -1;
            else if (!ea && eb) cmp = 1;
          }
          if (cmp !== 0) return cmp;
        }
        return 0;
      });

      items.forEach(el => container.appendChild(el));
    }

    // ri-ordina live anche al cambio criteri
    document.getElementById('sortCriteria')
      .addEventListener('change', sortResults);

    function isPivotHigh(kl, i, L, R) {
      if (i < L || i + R >= kl.length) return false;
      const h0 = +kl[i][2];
      for (let j = 1; j <= L; j++) if (+kl[i-j][2] >= h0) return false;
      for (let k = 1; k <= R; k++) if (+kl[i+k][2] >= h0) return false;
      return true;
    }

    function getTVInterval(iv) {
      const m = {'1m':'1','5m':'5','15m':'15','30m':'30','1h':'60','4h':'240','1d':'1D'};
      return m[iv] || '5';
    }
    function getTVLink(sym, iv, ex) {
      return `https://www.tradingview.com/chart/?symbol=${ex}:${sym}&interval=${getTVInterval(iv)}&theme=dark`;
    }
    function getExLink(sym, ex) {
      if (ex === 'binance')
        return `https://www.binance.com/en/trade/${sym.replace('USDC','')}_USDC`;
      if (ex === 'bybit')
        return `https://www.bybit.com/en/trade/spot/${sym}`;
      return '#';
    }
    function launchLink(u) { window.open(u, '_blank'); }

    async function sendTelegram(text) {
      await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          chat_id: TELEGRAM_CHAT_ID,
          text, parse_mode:'HTML'
        })
      });
    }

    function checkAlert(c) {
      const k = `${c.exchange}|${c.symbol}`,
            el = resultsMap.get(k),
            cb = el.querySelector('.alert-checkbox'),
            customPrice = parseFloat(el.querySelector('.custom-price').value) || 0,
            percentThreshold = parseFloat(
              document.getElementById('alertThreshold').value
            ) || 0;

      if (!cb.checked || alerted.has(k)) return;

      let trigger = false;
      // se hai inserito un prezzo assoluto
      if (customPrice > 0) {
        if (c.close <= customPrice) trigger = true;
      } else {
        // fallback percentuale
        if (+c.distance <= percentThreshold) trigger = true;
      }

      if (trigger) {
        sendTelegram(
          `üö® <b>${c.symbol}</b> ‚Äì ${c.exchange}\n` +
          `PivotHigh: ${c.pivotValue}\n` +
          `Close: ${c.close}\n` +
          `Œî%: ${c.distance}%\n` +
          `<a href="${c.tradingViewUrl}">TV</a>`
        );
        alerted.add(k);
        el.querySelector('.alert-indicator').textContent = '‚úÖ';
        el.classList.add('alerted');
      }
    }

    function upsertResult(c) {
      const k = `${c.exchange}|${c.symbol}`,
            container = document.getElementById('results'),
            old = resultsMap.get(k);
      let el = old;

      if (el) {
        // aggiornamento
        el.querySelector('.gain').textContent = `+${c.gain}%`;
        el.querySelector('.daily-change').textContent = `${c.dailyChange}%`;
        el.querySelector('.distance-value').textContent = `${c.distance}%`;
        el.querySelector('.volume-value').textContent = c.volume;
        el.querySelector('.pivottime').textContent = c.pivotTime;
        // non sovrascrivo il prezzo custom, solo l'indicatore
        el.querySelector('.alert-indicator').textContent =
          alerted.has(k) ? '‚úÖ' : '‚ùå';
      }
      else {
        // creazione nuovo blocco
        el = document.createElement('div');
        el.className = `coin ${c.exchange}`;
        el.dataset.pivotVal = c.pivotValue;
        el.innerHTML = `
          <div class="exchange-badge ${c.exchange}">
            ${c.exchange.toUpperCase()}
          </div>
          <div><strong>üí∞ ${c.symbol}</strong></div>
          <div>üìä Gain: <span class="gain">+${c.gain}%</span> |
               24h: <span class="daily-change">${c.dailyChange}%</span>
          </div>
          <div>üíß Volume: <span class="volume-value">${c.volume}</span></div>
          <div>‚ö° Distance: <span class="distance-value">
              ${c.distance}%</span></div>
          <div>‚öì PivotHigh: ${c.pivotValue} @ 
               <span class="pivottime">${c.pivotTime}</span>
          </div>
          <div>‚è± #${c.index} | ${c.timestamp}</div>
          <div style="margin-top:8px;">
            <a class="tradingview-link" href="#">TV</a>
            <a class="exchange-link ${c.exchange}" href="#">Exch</a>
          </div>
          <label class="alert-label">
            <input type="checkbox" class="alert-checkbox" />Allarme
            <span class="alert-indicator">‚ùå</span>
          </label>
          <label class="custom-label">
            <input type="number" class="custom-price" 
                   step="0.0001" placeholder="Prezzo" />
            Prezzo
          </label>
        `;
        // handlers
        const tv = el.querySelector('.tradingview-link'),
              exl = el.querySelector('.exchange-link'),
              cb = el.querySelector('.alert-checkbox'),
              cp = el.querySelector('.custom-price');

        tv.addEventListener('click', e => {
          e.preventDefault();
          launchLink(c.tradingViewUrl);
          tv.classList.add('checked');
          checked.add(k);
        });
        if (checked.has(k)) tv.classList.add('checked');

        exl.addEventListener('click', e => {
          e.preventDefault();
          launchLink(c.exchangeUrl);
        });

        // quando togli l'allarme ripristina stato
        cb.addEventListener('change', e => {
          if (!e.target.checked) {
            alerted.delete(k);
            el.querySelector('.alert-indicator').textContent = '‚ùå';
            el.classList.remove('alerted');
          }
        });

        // modifica prezzo custom = riattiva allarme
        cp.addEventListener('input', () => {
          cb.checked = true;
          el.querySelector('.alert-indicator').textContent = '‚ùå';
          el.classList.remove('alerted');
        });

        resultsMap.set(k, el);
        container.appendChild(el);
      }

      sortResults();
      checkAlert(c);
    }

    // (qui vanno le funzioni getBinanceMaxGain, getBybitMaxGain, getSymbols, cycleProcessing
    //  esattamente come prima, senza cambiare la logica di pivot/gain/distance,
    //  ti basta copiare quelle dal tuo file originario)

    // ‚Ä¶ COPIA QUI TUTTO IL TUO JS PER fetch API, isPivotHigh, cycleProcessing, processBatch ‚Ä¶
    // al termine ricollega:
    document.getElementById('startBtn')
      .addEventListener('click', cycleProcessing);

  </script>
</body>
</html>
