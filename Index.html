 <!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Screener + Pivot High (Stocks & Crypto)</title>
  <style>
    body { font-family:sans-serif; background:#f5f5f5; margin:0; }
    .container { max-width:960px; margin:40px auto; background:#fff;
      padding:20px; box-shadow:0 2px 8px rgba(0,0,0,.1); }
    h1,h2 { margin-top:0; }
    label, select, input, button { font-size:1rem; margin:0 8px 12px; }
    .row { display:flex; flex-wrap:wrap; align-items:center; }
    .row > * { margin-right:12px; }
    .hidden { display:none; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th,td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#f0f0f0; }
    #progress { font-weight:600; margin-left:10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Screener & Pivot High</h1>

    <div class="row">
      <label>Mercato
        <select id="market">
          <option value="stocks">Stocks</option>
          <option value="crypto">Crypto</option>
        </select>
      </label>

      <!-- Sezione Stocks -->
      <div id="stocksSect">
        <label>Indice
          <select id="idx">
            <option value="US">USA (S&P 500)</option>
            <option value="IT">Italia (FTSE MIB)</option>
          </select>
        </label>
      </div>

      <!-- Sezione Crypto -->
      <div id="cryptoSect" class="hidden">
        <label>Exchange
          <select id="exchange">
            <option value="binance">Binance (USDC)</option>
            <option value="bybit">Bybit (USDT)</option>
          </select>
        </label>
      </div>

      <label>Da
        <input type="date" id="start" />
      </label>
      <label>A
        <input type="date" id="end" />
      </label>

      <label>Pivot left
        <input type="number" id="pLeft" value="1" min="1" style="width:50px" />
      </label>
      <label>Pivot right
        <input type="number" id="pRight" value="1" min="1" style="width:50px" />
      </label>

      <button id="scan">Scansiona</button>
      <span id="progress"></span>
    </div>

    <h2>Top 10 asset sotto Pivot High</h2>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Asset</th>
          <th>Gain %</th>
          <th>Last Price</th>
          <th>Pivot High</th>
        </tr>
      </thead>
      <tbody id="out"></tbody>
    </table>
  </div>

  <script>
  const CORS = url => 'https://api.allorigins.win/raw?url='+encodeURIComponent(url);

  // toggle sections
  document.getElementById('market').addEventListener('change', e=>{
    const isCrypto = e.target.value==='crypto';
    document.getElementById('stocksSect').classList.toggle('hidden', isCrypto);
    document.getElementById('cryptoSect').classList.toggle('hidden', !isCrypto);
  });

  // carica tickers Stocks
  async function loadStocks(idx) {
    const wiki = idx==='US'
      ? 'https://en.wikipedia.org/wiki/List_of_S%26P_500_companies'
      : 'https://en.wikipedia.org/wiki/FTSE_MIB';
    const html = await fetch(CORS(wiki)).then(r=>r.text());
    const doc  = new DOMParser().parseFromString(html,'text/html');
    const rows = doc.querySelectorAll('table.wikitable tbody tr');
    const list = [];
    rows.forEach((tr,i) => {
      if(i===0) return;
      const cell = tr.querySelector('td');
      if(!cell) return;
      let t = cell.textContent.trim();
      if(idx==='US') t = t.replace('.', '-');
      else           t = t + '.MI';
      list.push(t);
    });
    return list.slice(0,200);
  }

  // carica coppie Binance USDC
  async function loadBinance() {
    const url = 'https://api.binance.com/api/v3/exchangeInfo';
    const data = await fetch(CORS(url)).then(r=>r.json());
    return data.symbols
      .filter(s=> s.status==='TRADING' && s.quoteAsset==='USDC')
      .map(s=> s.symbol);
  }

  // carica coppie Bybit USDT
  async function loadBybit() {
    const url = 'https://api.bybit.com/spot/v1/symbols';
    const data = await fetch(CORS(url)).then(r=>r.json());
    return data.result
      .filter(s=> s.status==='Trading' && s.quoteCurrency==='USDT')
      .map(s=> s.name);
  }

  // fetch prezzi stocks da Yahoo
  async function fetchStockPrices(sym, start, end) {
    const p1 = Math.floor(start.getTime()/1000);
    const p2 = Math.floor(end.getTime()/1000);
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}`
              + `?period1=${p1}&period2=${p2}&interval=1d`;
    const j = await fetch(CORS(url)).then(r=>r.json());
    const res = j.chart?.result?.[0];
    if(!res) return null;
    return {
      highs: res.indicators.quote[0].high,
      closes: res.indicators.quote[0].close
    };
  }

  // fetch prezzi Binance
  async function fetchBinancePrices(sym, start, end) {
    const url = `https://api.binance.com/api/v3/klines`
      + `?symbol=${sym}&interval=1d`
      + `&startTime=${start.getTime()}&endTime=${end.getTime()}`;
    const data = await fetch(CORS(url)).then(r=>r.json());
    if(!Array.isArray(data)) return null;
    const highs = data.map(k=>+k[2]);
    const closes= data.map(k=>+k[4]);
    return { highs, closes };
  }

  // fetch prezzi Bybit
  async function fetchBybitPrices(sym, start, end) {
    const url = `https://api.bybit.com/spot/quote/v1/kline`
      + `?symbol=${sym}&interval=1d`
      + `&start=${Math.floor(start.getTime()/1000)}`
      + `&end=${Math.floor(end.getTime()/1000)}`;
    const j = await fetch(CORS(url)).then(r=>r.json());
    const list = j.result || [];
    const highs  = list.map(o=>+o.high);
    const closes = list.map(o=>+o.close);
    return { highs, closes };
  }

  // trova ultimo Pivot High
  function findLastPivotHigh(highs, left, right) {
    const pivots = [];
    for(let i=left; i<highs.length-right; i++){
      const H = highs[i];
      if(H==null) continue;
      let ok=true;
      for(let j=1;j<=left;j++)  if(highs[i-j]>=H) ok=false;
      for(let j=1;j<=right;j++) if(highs[i+j]>=H) ok=false;
      if(ok) pivots.push({i,value:H});
    }
    return pivots.length ? pivots[pivots.length-1].value : null;
  }

  // scan button
  document.getElementById('scan').onclick = async function(){
    const market  = document.getElementById('market').value;
    const idx     = document.getElementById('idx').value;
    const exch    = document.getElementById('exchange').value;
    const sdStr   = document.getElementById('start').value;
    const edStr   = document.getElementById('end').value;
    const left    = +document.getElementById('pLeft').value;
    const right   = +document.getElementById('pRight').value;
    const outTb   = document.getElementById('out');
    const prog    = document.getElementById('progress');
    outTb.innerHTML='';
    if(!sdStr||!edStr){ alert('Imposta date'); return; }
    this.disabled=true;
    prog.textContent='Caricamento assetâ€¦';

    // load list
    let list = [];
    if(market==='stocks') {
      list = await loadStocks(idx);
    } else if(exch==='binance') {
      list = await loadBinance();
    } else {
      list = await loadBybit();
    }

    const start = new Date(sdStr),
          end   = new Date(edStr),
          results = [];

    for(let i=0;i<list.length;i++){
      const sym = list[i];
      prog.textContent=`(${i+1}/${list.length}) ${sym}`;
      let data=null;
      if(market==='stocks') data = await fetchStockPrices(sym,start,end);
      else if(exch==='binance') data = await fetchBinancePrices(sym,start,end);
      else data = await fetchBybitPrices(sym,start,end);
      if(!data) continue;
      const {highs, closes} = data;
      if(!closes.length) continue;

      const first = closes[0],
            last  = closes[closes.length-1],
            gain  = (last-first)/first*100,
            pivot = findLastPivotHigh(highs, left, right);

      if(pivot!=null && last < pivot) {
        results.push({ sym, gain, price:last, pivot });
      }
    }

    results.sort((a,b)=>b.gain - a.gain);
    const top10 = results.slice(0,10);
    top10.forEach((x,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML=`
        <td>${i+1}</td>
        <td>${x.sym}</td>
        <td>${x.gain.toFixed(2)}%</td>
        <td>${x.price.toFixed(6)}</td>
        <td>${x.pivot.toFixed(6)}</td>`;
      outTb.appendChild(tr);
    });

    prog.textContent=`Fatto: ${top10.length} asset trovati.`;
    this.disabled=false;
  };
  </script>
</body>
</html>
